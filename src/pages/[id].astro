---
import { getCollection, render } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import { format } from 'date-fns';
import { getReadingTimeFromBody } from '../utils/readingTime';
import { getRelatedPosts } from '../utils/relatedPosts';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { id: post.id },
    props: { post, allPosts: posts },
  }));
}

const { post, allPosts } = Astro.props;
const rendered = await render(post);
const { Content } = rendered;
const readingTime = getReadingTime(rendered);
const relatedPosts = getRelatedPosts(post, allPosts, 3);
---

<Layout 
  title={`${post.data.title} - Sam Julien`}
  description={post.data.description}
  image={post.data.ogimage}
>
  <article class="prose lg:prose-xl max-w-none">
    <h2>{post.data.title}</h2>
    <div class="text-gray-600 mb-8 flex flex-wrap gap-2 items-center">
      <time>
        Last updated: {post.data.date_updated ? format(post.data.date_updated, 'MMMM yyyy') : format(post.data.date, 'MMMM yyyy')}
      </time>
      <span aria-hidden="true">â€¢</span>
      <span>{readingTime}</span>
    </div>
    <Content />
  </article>
  <RelatedPosts posts={relatedPosts} />
</Layout>