---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { format } from 'date-fns';
import { getReadingTimeFromBody } from '../../utils/readingTime';

export async function getStaticPaths() {
  const posts = await getCollection('blog');

  // Get all unique tags and create slug mappings
  const tagMap = new Map<string, string>(); // slug -> original tag name
  posts.forEach(post => {
    post.data.tags?.forEach(tag => {
      const slug = tag.toLowerCase().replace(/\s+/g, '-');
      tagMap.set(slug, tag);
    });
  });

  return Array.from(tagMap.entries()).map(([slug, tag]) => ({
    params: { tag: slug },
    props: {
      tag,
      posts: posts
        .filter(post => post.data.tags?.includes(tag))
        .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()),
    },
  }));
}

const { tag, posts } = Astro.props;
---

<Layout title={`${tag} - Sam Julien`}>
  <div class="mb-8">
    <a href="/tags" class="text-brand hover:text-brand-dark">
      &larr; All Tags
    </a>
  </div>

  <h1 class="text-4xl font-bold mb-4">{tag}</h1>
  <p class="text-gray-600 dark:text-gray-400 mb-8">
    {posts.length} {posts.length === 1 ? 'article' : 'articles'}
  </p>

  <div class="space-y-12">
    {posts.map(post => (
      <article class="border-b border-gray-200 dark:border-gray-700 pb-8">
        <h2 class="text-2xl font-bold mb-2">
          <a href={`/${post.id}`} class="hover:text-brand">
            {post.data.title}
          </a>
        </h2>
        <div class="text-gray-600 dark:text-gray-400 mb-4 flex flex-wrap gap-2 items-center">
          <time>
            Last updated: {post.data.date_updated ? format(post.data.date_updated, 'MMMM yyyy') : format(post.data.date, 'MMMM yyyy')}
          </time>
          <span aria-hidden="true">â€¢</span>
          <span>{getReadingTimeFromBody(post)}</span>
        </div>
        <p class="text-gray-700 dark:text-gray-300">{post.data.description}</p>
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="mt-4 flex flex-wrap gap-2">
            {post.data.tags.map(t => (
              <a
                href={`/tags/${encodeURIComponent(t.toLowerCase().replace(/\s+/g, '-'))}`}
                class={`text-xs px-2 py-1 rounded transition-colors ${
                  t === tag
                    ? 'bg-brand text-white'
                    : 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-800'
                }`}
              >
                {t}
              </a>
            ))}
          </div>
        )}
        <a href={`/${post.id}`} class="text-brand hover:text-brand-dark mt-4 inline-block">
          Read More &rarr;
        </a>
      </article>
    ))}
  </div>
</Layout>
