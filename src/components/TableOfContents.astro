---
interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
  minHeadings?: number;
}

const { headings, minHeadings = 3 } = Astro.props;

// Filter to only h2 and h3
const filteredHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);

// Don't render if not enough headings
const shouldRender = filteredHeadings.length >= minHeadings;
---

{shouldRender && (
  <nav class="toc-container lg:h-full" aria-label="Table of contents">
    <!-- Mobile: Collapsible -->
    <details class="lg:hidden mb-6 bg-gray-50 dark:bg-gray-800 rounded-lg">
      <summary class="cursor-pointer p-4 font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
        </svg>
        Table of Contents
      </summary>
      <ul class="p-4 pt-0 space-y-2">
        {filteredHeadings.map(heading => (
          <li class={heading.depth === 3 ? 'ml-4' : ''}>
            <a
              href={`#${heading.slug}`}
              class="text-gray-600 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 transition-colors block py-1"
            >
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </details>

    <!-- Desktop: Sticky sidebar -->
    <div class="hidden lg:block lg:h-full">
      <div class="sticky top-8">
        <h2 class="text-sm font-semibold text-gray-900 dark:text-gray-100 uppercase tracking-wide mb-4">
          On this page
        </h2>
        <ul class="space-y-2 text-sm border-l-2 border-gray-200 dark:border-gray-700">
          {filteredHeadings.map(heading => (
            <li class={heading.depth === 3 ? 'ml-2' : ''}>
              <a
                href={`#${heading.slug}`}
                class="toc-link block py-1 pl-4 -ml-px border-l-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 hover:border-green-500 transition-colors"
                data-heading={heading.slug}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </div>
  </nav>
)}

<script is:inline>
  // Highlight current section in TOC based on scroll position
  (function() {
    // Small delay to ensure content is fully rendered
    setTimeout(function initTocHighlighting() {
      var tocLinks = Array.prototype.slice.call(document.querySelectorAll('.toc-link'));
      if (tocLinks.length === 0) return;

      // Find all h2 and h3 headings in the article (the prose content area)
      var article = document.querySelector('article.prose');
      if (!article) {
        article = document.querySelector('article');
      }
      if (!article) return;

      // Get all h2 and h3 headings, excluding the page title (first h2) and TOC title
      var allHeadings = Array.prototype.slice.call(article.querySelectorAll('h2, h3'));

      // Filter out the TOC's own "On this page" heading and the page title
      var headingElements = allHeadings.filter(function(h) {
        // Skip if it's inside the TOC nav
        if (h.closest('.toc-container')) return false;
        // Skip if it's the page title (usually first h2 without an id)
        if (h.tagName === 'H2' && !h.id && allHeadings.indexOf(h) === 0) return false;
        return true;
      });

      if (headingElements.length === 0) return;

      var currentActive = null;

      function setActiveLinkByIndex(index) {
        // Remove active class from previous
        if (currentActive) {
          currentActive.classList.remove('border-green-500', 'text-green-600', 'dark:text-green-400');
          currentActive.classList.add('border-transparent', 'text-gray-600', 'dark:text-gray-400');
        }

        if (index < 0 || index >= tocLinks.length) {
          currentActive = null;
          return;
        }

        var activeLink = tocLinks[index];
        if (activeLink) {
          activeLink.classList.remove('border-transparent', 'text-gray-600', 'dark:text-gray-400');
          activeLink.classList.add('border-green-500', 'text-green-600', 'dark:text-green-400');
          currentActive = activeLink;
        }
      }

      function updateActiveHeading() {
        var scrollY = window.scrollY;
        var offset = 100;

        // Find the last heading that's been scrolled past
        var activeIndex = -1;
        for (var i = 0; i < headingElements.length; i++) {
          var heading = headingElements[i];
          var rect = heading.getBoundingClientRect();
          var top = rect.top + window.scrollY;
          if (top <= scrollY + offset) {
            activeIndex = i;
          } else {
            break;
          }
        }

        setActiveLinkByIndex(activeIndex);
      }

      // Update on scroll with throttling
      var ticking = false;
      window.addEventListener('scroll', function() {
        if (!ticking) {
          requestAnimationFrame(function() {
            updateActiveHeading();
            ticking = false;
          });
          ticking = true;
        }
      });

      // Initial update
      updateActiveHeading();
    }, 100);
  })();
</script>
